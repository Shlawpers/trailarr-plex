import{a as $}from"./chunk-S6KXSEER.js";import{a as U,b as F}from"./chunk-SN7ZTHVN.js";import{Ib as y,Ja as o,Mb as _,Nb as f,Ob as C,Ra as q,Wa as p,X as M,a as k,ab as u,b as T,ba as h,ec as R,fc as L,hb as n,ib as e,ja as O,jb as c,ka as I,la as b,nb as P,ob as D,pb as g,pc as N,rc as E,v as S,wb as w,yb as r,zb as m}from"./chunk-LS7CSANC.js";var j=(()=>{class i{constructor(){this.http=h(N),this.tasksUrl=E.apiUrl+E.tasks,this.schedulesUrl=this.tasksUrl+"schedules",this.queueUrl=this.tasksUrl+"queue"}convertTime(t){let a=[{unit:"second",value:60},{unit:"minute",value:60},{unit:"hour",value:24},{unit:"day",value:7}];for(let{unit:s,value:l}of a){if(t<l)return`${t} ${s}${t===1?"":"s"}`;t=Math.floor(t/l)}return`${t} ${t===1?"week":"weeks"}`}convertDate(t){return t?new Date(t+"Z"):null}formatDuration(t){if(t<1)return"00:00:00";let a=Math.floor(t/3600).toString().padStart(2,"0"),s=Math.floor(t%3600/60).toString().padStart(2,"0"),l=(t%60).toString().padStart(2,"0");return`${a}:${s}:${l}`}getScheduledTasks(){return this.http.get(this.schedulesUrl).pipe(S(t=>Object.entries(t).map(([a,s])=>T(k({id:a},s),{interval:this.convertTime(s.interval),last_run_duration:this.formatDuration(s.last_run_duration),last_run_start:this.convertDate(s.last_run_start),next_run:this.convertDate(s.next_run)}))))}getQueuedTasks(){return this.http.get(this.queueUrl).pipe(S(t=>Object.entries(t).map(([a,s])=>T(k({id:a},s),{duration:this.formatDuration(s.duration),finished:this.convertDate(s.finished),started:this.convertDate(s.started)}))))}runScheduledTask(t){return this.http.get(this.tasksUrl+"run/"+t)}static{this.\u0275fac=function(a){return new(a||i)}}static{this.\u0275prov=M({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function V(i,d){i&1&&(n(0,"div",5),c(1,"div",6)(2,"div",6)(3,"div",6)(4,"div",6),e())}function G(i,d){if(i&1){let t=P();n(0,"td",15),D("click",function(){O(t);let s=g().$implicit,l=g(2);return s.last_run_status="Running",I(l.runTask(s.task_id))}),b(),n(1,"svg",16),c(2,"path",17),e()()}}function H(i,d){i&1&&(n(0,"td",18),b(),n(1,"svg",19),c(2,"path",20),e()())}function W(i,d){if(i&1&&(n(0,"tr",12)(1,"td",10),r(2),e(),n(3,"td"),r(4),e(),n(5,"td"),r(6),_(7,"timeago"),e(),n(8,"td"),r(9),e(),n(10,"td"),r(11),e(),n(12,"td"),r(13),_(14,"timeago"),e(),p(15,G,3,0,"td",13)(16,H,3,0,"td",14),e()),i&2){let t=d.$implicit;o(2),m(t.name),o(2),m(t.interval),o(2),m(t.last_run_start?f(7,8,t.last_run_start):"Not run yet"),o(3),m(t.last_run_status),o(2),m(t.last_run_duration),o(2),m(t.next_run?f(14,10,t.next_run):"Not scheduled"),o(2),u("ngIf",t.last_run_status.toLowerCase()!="running"),o(),u("ngIf",t.last_run_status.toLowerCase()=="running")}}function z(i,d){if(i&1&&(n(0,"div",7)(1,"table",8)(2,"tr",9)(3,"th",10),r(4,"Name"),e(),n(5,"th"),r(6,"Interval"),e(),n(7,"th"),r(8,"Last Run"),e(),n(9,"th"),r(10,"Last Run Status"),e(),n(11,"th"),r(12,"Last Run Duration"),e(),n(13,"th"),r(14,"Next Run"),e(),c(15,"th"),e(),p(16,W,17,12,"tr",11),e()()),i&2){let t=g();o(16),u("ngForOf",t.scheduledTasks)}}function A(i,d){i&1&&(n(0,"div",5),c(1,"div",6)(2,"div",6)(3,"div",6)(4,"div",6),e())}function J(i,d){if(i&1&&(n(0,"tr",12)(1,"td",10),r(2),e(),n(3,"td"),r(4),e(),n(5,"td"),r(6),_(7,"timeago"),e(),n(8,"td"),r(9),_(10,"timeago"),e(),n(11,"td"),r(12),e()()),i&2){let t=d.$implicit;o(2),m(t.name),o(2),m(t.status),o(2),m(t.started?f(7,5,t.started):"Pending"),o(3),m(t.finished?f(10,7,t.finished):"-"),o(3),m(t.duration)}}function K(i,d){if(i&1&&(n(0,"div",21)(1,"table",8)(2,"tr",9)(3,"th",10),r(4,"Name"),e(),n(5,"th"),r(6,"Status"),e(),n(7,"th"),r(8,"Started"),e(),n(9,"th"),r(10,"Finished"),e(),n(11,"th"),r(12,"Duration"),e()(),p(13,J,13,9,"tr",11),e()()),i&2){let t=g();o(13),u("ngForOf",t.queuedTasks)}}var B=(()=>{class i{constructor(){this.tasksService=h(j),this.websocketService=h($),this.scheduledTasks=[],this.queuedTasks=[],this.isLoading1=!0,this.isLoading2=!0}ngOnInit(){this.refreshTaskData();let t=()=>{this.refreshTaskData()},a=()=>{clearTimeout(this.timeoutRef),this.webSocketSubscription?.unsubscribe()};this.webSocketSubscription=this.websocketService.connect().subscribe({next:t,error:a,complete:a})}getSecondsToNextScheduledEvent(t,a){let s=30;for(let l of a)if(l.status==="Running")return 10;for(let l of t){let x=new Date().getTime(),Z=l.next_run.getTime(),v=Math.floor((Z-x)/1e3)+2;if(v=Math.max(v,3),v===3)return 3;s=Math.min(s,v)}return s}refreshTaskData(){clearTimeout(this.timeoutRef),this.tasksService.getScheduledTasks().subscribe(a=>{this.scheduledTasks=a,this.isLoading1=!1}),this.tasksService.getQueuedTasks().subscribe(a=>{this.queuedTasks=a,this.isLoading2=!1});let t=this.getSecondsToNextScheduledEvent(this.scheduledTasks,this.queuedTasks);this.timeoutRef=setTimeout(()=>{this.refreshTaskData()},t*1e3)}ngOnDestroy(){clearTimeout(this.timeoutRef),this.webSocketSubscription?.unsubscribe()}runTask(t){this.tasksService.runScheduledTask(t).subscribe(a=>{console.log(a)})}static{this.\u0275fac=function(a){return new(a||i)}}static{this.\u0275cmp=q({type:i,selectors:[["app-tasks"]],features:[y([])],decls:13,vars:4,consts:[["schedulesLoaded",""],["queueLoaded",""],[1,"tasks-container"],[1,"text-heading"],["class","loading-wave center",4,"ngIf","ngIfElse"],[1,"loading-wave","center"],[1,"loading-bar"],[1,"table-container"],[1,"tasks-table"],[1,"table-row","header"],[1,"name"],["class","table-row",4,"ngFor","ngForOf"],[1,"table-row"],["title","Run task now",3,"click",4,"ngIf"],["title","Task is running",4,"ngIf"],["title","Run task now",3,"click"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M382-306.67 653.33-480 382-653.33v346.66ZM480-80q-82.33 0-155.33-31.5-73-31.5-127.34-85.83Q143-251.67 111.5-324.67T80-480q0-83 31.5-156t85.83-127q54.34-54 127.34-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 82.33-31.5 155.33-31.5 73-85.5 127.34Q709-143 636-111.5T480-80Z"],["title","Task is running"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960",1,"loading"],["d","M343-107q-120-42-194.5-146.5T74-490q0-29 4-57.5T91-604l-57 33-37-62 185-107 106 184-63 36-54-92q-13 30-18.5 60.5T147-490q0 113 65.5 200T381-171l-38 64Zm291-516v-73h107q-47-60-115.5-93.5T480-823q-66 0-123.5 24T255-734l-38-65q54-45 121-71t142-26q85 0 160.5 33T774-769v-67h73v213H634ZM598-1 413-107l107-184 62 37-54 94q123-17 204.5-110.5T814-489q0-19-2.5-37.5T805-563h74q4 18 6 36.5t2 36.5q0 142-87 251.5T578-96l56 33-36 62Z"],[1,"table-container","last-table"]],template:function(a,s){if(a&1&&(n(0,"div",2)(1,"div",3),r(2,"Scheduled"),e(),c(3,"hr"),p(4,V,5,0,"div",4)(5,z,17,1,"ng-template",null,0,C),n(7,"div",3),r(8,"Queue"),e(),c(9,"hr"),p(10,A,5,0,"div",4)(11,K,14,1,"ng-template",null,1,C),e()),a&2){let l=w(6),x=w(12);o(4),u("ngIf",s.isLoading1)("ngIfElse",l),o(6),u("ngIf",s.isLoading1)("ngIfElse",x)}},dependencies:[L,R,F,U],styles:[".tasks-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:1rem}@media (width < 765px){.tasks-container[_ngcontent-%COMP%]{padding:.5rem}}.text-heading[_ngcontent-%COMP%]{margin-top:1rem;text-align:left;font-size:2rem}.center[_ngcontent-%COMP%]{margin:auto}.table-container[_ngcontent-%COMP%]{width:100%;overflow-x:auto;min-height:25%;-webkit-overflow-scrolling:touch;margin-top:.5rem;margin-bottom:2rem}.last-table[_ngcontent-%COMP%]{margin-bottom:0}.tasks-table[_ngcontent-%COMP%]{width:100%;max-width:100%;white-space:nowrap;border-collapse:collapse}.tasks-table[_ngcontent-%COMP%]   .table-row[_ngcontent-%COMP%]{border-bottom:1px solid var(--color-outline);white-space:nowrap;text-align:left}.tasks-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .tasks-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:1rem .5rem}.tasks-table[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]{font-weight:700;border-bottom:2px solid var(--color-outline)}.tasks-table[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{width:100%}.table-row[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{margin:0 .5rem;width:1rem;fill:var(--color-primary);cursor:pointer}.loading[_ngcontent-%COMP%]{cursor:progress;animation:spin-animation 2s linear infinite}.table-row[_ngcontent-%COMP%]:hover:not(:first-child){background-color:var(--color-tertiary-container)}"]})}}return i})();var ht=[{path:"",loadComponent:()=>B}];export{ht as default};
