import{a as $}from"./chunk-IK2DGUM6.js";import{a as U,b as F}from"./chunk-EUGSCBCM.js";import{a as j}from"./chunk-LLDKFHLB.js";import{Gc as N,Ib as w,Jb as r,Jc as E,Kb as m,Na as s,Tb as y,Xb as g,Y as M,Ya as q,Yb as f,Zb as C,a as v,b as T,bb as u,ca as h,hb as p,ka as I,la as O,ma as b,oc as L,pc as R,rb as i,sb as e,tb as d,v as S,xb as P,yb as D,zb as _}from"./chunk-M4QNQTBX.js";var B=(()=>{class n{constructor(){this.http=h(N),this.tasksUrl=E.apiUrl+E.tasks,this.schedulesUrl=this.tasksUrl+"schedules",this.queueUrl=this.tasksUrl+"queue"}convertTime(t){let a=[{unit:"second",value:60},{unit:"minute",value:60},{unit:"hour",value:24},{unit:"day",value:7}];for(let{unit:o,value:l}of a){if(t<l)return`${t} ${o}${t===1?"":"s"}`;t=Math.floor(t/l)}return`${t} ${t===1?"week":"weeks"}`}convertDate(t){return t?new Date(t+"Z"):null}formatDuration(t){if(t<1)return"00:00:00";let a=Math.floor(t/3600).toString().padStart(2,"0"),o=Math.floor(t%3600/60).toString().padStart(2,"0"),l=(t%60).toString().padStart(2,"0");return`${a}:${o}:${l}`}getScheduledTasks(){return this.http.get(this.schedulesUrl).pipe(S(t=>Object.entries(t).map(([a,o])=>T(v({id:a},o),{interval:this.convertTime(o.interval),last_run_duration:this.formatDuration(o.last_run_duration),last_run_start:this.convertDate(o.last_run_start),next_run:this.convertDate(o.next_run)}))))}getQueuedTasks(){return this.http.get(this.queueUrl).pipe(S(t=>Object.entries(t).map(([a,o])=>T(v({id:a},o),{duration:this.formatDuration(o.duration),finished:this.convertDate(o.finished),started:this.convertDate(o.started)}))))}runScheduledTask(t){return this.http.get(this.tasksUrl+"run/"+t)}static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275prov=M({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();function G(n,c){n&1&&d(0,"app-load-indicator",5)}function H(n,c){if(n&1){let t=P();i(0,"td",14),D("click",function(){I(t);let o=_().$implicit,l=_(2);return o.last_run_status="Running",O(l.runTask(o.task_id))}),b(),i(1,"svg",15),d(2,"path",16),e()()}}function W(n,c){n&1&&(i(0,"td",17),b(),i(1,"svg",18),d(2,"path",19),e()())}function z(n,c){if(n&1&&(i(0,"tr",11)(1,"td",9),r(2),e(),i(3,"td"),r(4),e(),i(5,"td"),r(6),g(7,"timeago"),e(),i(8,"td"),r(9),e(),i(10,"td"),r(11),e(),i(12,"td"),r(13),g(14,"timeago"),e(),u(15,H,3,0,"td",12)(16,W,3,0,"td",13),e()),n&2){let t=c.$implicit;s(2),m(t.name),s(2),m(t.interval),s(2),m(t.last_run_start?f(7,8,t.last_run_start):"Not run yet"),s(3),m(t.last_run_status),s(2),m(t.last_run_duration),s(2),m(t.next_run?f(14,10,t.next_run):"Not scheduled"),s(2),p("ngIf",t.last_run_status.toLowerCase()!="running"),s(),p("ngIf",t.last_run_status.toLowerCase()=="running")}}function A(n,c){if(n&1&&(i(0,"div",6)(1,"table",7)(2,"tr",8)(3,"th",9),r(4,"Name"),e(),i(5,"th"),r(6,"Interval"),e(),i(7,"th"),r(8,"Last Run"),e(),i(9,"th"),r(10,"Last Run Status"),e(),i(11,"th"),r(12,"Last Run Duration"),e(),i(13,"th"),r(14,"Next Run"),e(),d(15,"th"),e(),u(16,z,17,12,"tr",10),e()()),n&2){let t=_();s(16),p("ngForOf",t.scheduledTasks)}}function J(n,c){n&1&&d(0,"app-load-indicator",5)}function K(n,c){if(n&1&&(i(0,"tr",11)(1,"td",9),r(2),e(),i(3,"td"),r(4),e(),i(5,"td"),r(6),g(7,"timeago"),e(),i(8,"td"),r(9),g(10,"timeago"),e(),i(11,"td"),r(12),e()()),n&2){let t=c.$implicit;s(2),m(t.name),s(2),m(t.status),s(2),m(t.started?f(7,5,t.started):"Pending"),s(3),m(t.finished?f(10,7,t.finished):"-"),s(3),m(t.duration)}}function X(n,c){if(n&1&&(i(0,"div",20)(1,"table",7)(2,"tr",8)(3,"th",9),r(4,"Name"),e(),i(5,"th"),r(6,"Status"),e(),i(7,"th"),r(8,"Started"),e(),i(9,"th"),r(10,"Finished"),e(),i(11,"th"),r(12,"Duration"),e()(),u(13,K,13,9,"tr",10),e()()),n&2){let t=_();s(13),p("ngForOf",t.queuedTasks)}}var Z=(()=>{class n{constructor(){this.tasksService=h(B),this.websocketService=h($),this.scheduledTasks=[],this.queuedTasks=[],this.isLoading1=!0,this.isLoading2=!0}ngOnInit(){this.refreshTaskData();let t=()=>{this.refreshTaskData()},a=()=>{clearTimeout(this.timeoutRef),this.webSocketSubscription?.unsubscribe()};this.webSocketSubscription=this.websocketService.connect().subscribe({next:t,error:a,complete:a})}getSecondsToNextScheduledEvent(t,a){let o=30;for(let l of a)if(l.status==="Running")return 10;for(let l of t){let k=new Date().getTime(),Q=l.next_run.getTime(),x=Math.floor((Q-k)/1e3)+2;if(x=Math.max(x,3),x===3)return 3;o=Math.min(o,x)}return o}refreshTaskData(){clearTimeout(this.timeoutRef),this.tasksService.getScheduledTasks().subscribe(a=>{this.scheduledTasks=a,this.isLoading1=!1}),this.tasksService.getQueuedTasks().subscribe(a=>{this.queuedTasks=a,this.isLoading2=!1});let t=this.getSecondsToNextScheduledEvent(this.scheduledTasks,this.queuedTasks);this.timeoutRef=setTimeout(()=>{this.refreshTaskData()},t*1e3)}ngOnDestroy(){clearTimeout(this.timeoutRef),this.webSocketSubscription?.unsubscribe()}runTask(t){this.tasksService.runScheduledTask(t).subscribe(a=>{console.log(a)})}static{this.\u0275fac=function(a){return new(a||n)}}static{this.\u0275cmp=q({type:n,selectors:[["app-tasks"]],features:[y([])],decls:13,vars:4,consts:[["schedulesLoaded",""],["queueLoaded",""],[1,"tasks-container"],[1,"text-heading"],["class","center",4,"ngIf","ngIfElse"],[1,"center"],[1,"table-container"],[1,"tasks-table"],[1,"table-row","header"],[1,"name"],["class","table-row",4,"ngFor","ngForOf"],[1,"table-row"],["title","Run task now",3,"click",4,"ngIf"],["title","Task is running",4,"ngIf"],["title","Run task now",3,"click"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960"],["d","M382-306.67 653.33-480 382-653.33v346.66ZM480-80q-82.33 0-155.33-31.5-73-31.5-127.34-85.83Q143-251.67 111.5-324.67T80-480q0-83 31.5-156t85.83-127q54.34-54 127.34-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 82.33-31.5 155.33-31.5 73-85.5 127.34Q709-143 636-111.5T480-80Z"],["title","Task is running"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 -960 960 960",1,"loading"],["d","M343-107q-120-42-194.5-146.5T74-490q0-29 4-57.5T91-604l-57 33-37-62 185-107 106 184-63 36-54-92q-13 30-18.5 60.5T147-490q0 113 65.5 200T381-171l-38 64Zm291-516v-73h107q-47-60-115.5-93.5T480-823q-66 0-123.5 24T255-734l-38-65q54-45 121-71t142-26q85 0 160.5 33T774-769v-67h73v213H634ZM598-1 413-107l107-184 62 37-54 94q123-17 204.5-110.5T814-489q0-19-2.5-37.5T805-563h74q4 18 6 36.5t2 36.5q0 142-87 251.5T578-96l56 33-36 62Z"],[1,"table-container","last-table"]],template:function(a,o){if(a&1&&(i(0,"div",2)(1,"div",3),r(2,"Scheduled"),e(),d(3,"hr"),u(4,G,1,0,"app-load-indicator",4)(5,A,17,1,"ng-template",null,0,C),i(7,"div",3),r(8,"Queue"),e(),d(9,"hr"),u(10,J,1,0,"app-load-indicator",4)(11,X,14,1,"ng-template",null,1,C),e()),a&2){let l=w(6),k=w(12);s(4),p("ngIf",o.isLoading1)("ngIfElse",l),s(6),p("ngIf",o.isLoading1)("ngIfElse",k)}},dependencies:[R,L,j,F,U],styles:[".tasks-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:1rem}@media (width < 765px){.tasks-container[_ngcontent-%COMP%]{padding:.5rem}}.text-heading[_ngcontent-%COMP%]{margin-top:1rem;text-align:left;font-size:2rem}.center[_ngcontent-%COMP%]{margin:auto}.table-container[_ngcontent-%COMP%]{width:100%;overflow-x:auto;min-height:25%;-webkit-overflow-scrolling:touch;margin-top:.5rem;margin-bottom:2rem}.last-table[_ngcontent-%COMP%]{margin-bottom:0}.tasks-table[_ngcontent-%COMP%]{width:100%;max-width:100%;white-space:nowrap;border-collapse:collapse}.tasks-table[_ngcontent-%COMP%]   .table-row[_ngcontent-%COMP%]{border-bottom:1px solid var(--color-outline);white-space:nowrap;text-align:left}.tasks-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .tasks-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:1rem .5rem}.tasks-table[_ngcontent-%COMP%]   .header[_ngcontent-%COMP%]{font-weight:700;border-bottom:2px solid var(--color-outline)}.tasks-table[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{width:100%}.table-row[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{margin:0 .5rem;width:1rem;fill:var(--color-primary);cursor:pointer}.loading[_ngcontent-%COMP%]{cursor:progress;animation:spin-animation 2s linear infinite}.table-row[_ngcontent-%COMP%]:hover:not(:first-child){background-color:var(--color-tertiary-container)}"]})}}return n})();var gt=[{path:"",loadComponent:()=>Z}];export{gt as default};
